import { BlogLayout } from "@/components/BlogLayout";

import { CodeWindow } from "@/components/CodeWindow";
import {motion} from "framer-motion";

export const meta = {
  date: "2023-08-18",
  title: "Build a Nextjs app with Supabase Auth, easy.",
  description:
    "Learn how to build a Nextjs app with Supabase Auth, easy.",
  image:
    "/images/blog/nextjs-supabase.jpg",
  tags: ["Clean Code"],
};

export default (props) => <BlogLayout meta={meta} {...props} />;

We will use Shadcn/ui for the UI components and create mostly client-side components. <br/>
We will look at server-side components another time.

We will use pnpm as package manager. Make sure you have at least:

- Node.js 22 or later
- pnpm 9 or later

To create the project, we will execute the following command in the terminal:

<CodeWindow>
```bash
    pnpm create next-app@latest <my-app> --typescript --tailwind --eslint
```
</CodeWindow>
You can accept the default options in the prompts you see on the screen.

Then we initialize the Shadcn/ui configuration.

<CodeWindow>
```bash
    pnpm dlx shadcn-ui@latest init
```
</CodeWindow>

You can accept the default options in the prompts you see on the screen.

This will create a ``components.json`` file with the instructions for the Shadcn/ui CLI.

Then we will add some normalizations to layout.tsx by applying the cn usage to combine plain text and variables in the HTML tag classes.

Replace the contents of the layout.tsx file with the following code:


<CodeWindow title="layout.tsx">

```TSX
import type {Metadata} from "next";
import { Inter as FontSans } from "next/font/google"
import "./globals.css";
import {cn} from "@/lib/utils";
import {ReactNode} from "react";

const fontSans = FontSans({
    subsets: ["latin"],
    variable: "--font-sans",
})

export const metadata: Metadata = {
    title: "Create Next App",
    description: "Generated by create next app",
};

export default function RootLayout({
                                       children,
                                   }: Readonly<{
    children: ReactNode;
}>) {
    return (
        <html lang="en">
        <body className={cn(
            "min-h-screen bg-background font-sans a   ntialiased",
            fontSans.variable
        )}>
        {children}
        </body>
        </html>
    );
}
```

</CodeWindow>

As a last step in the configuration, we must extend configure **`theme.extend.fontFamily`** in **`tailwind.config.js`**.

The final contents of **`tailwind.config.ts`** should be as follows:

<CodeWindow title="tailwind.config.ts">

```JS
const { fontFamily } = require("tailwindcss/defaultTheme")
import type { Config } from "tailwindcss"

const config = {
  darkMode: ["class"],
  content: [
    './pages/**/*.{ts,tsx}',
    './components/**/*.{ts,tsx}',
    './app/**/*.{ts,tsx}',
    './src/**/*.{ts,tsx}',
	],    
  prefix: "",
  theme: {
    container: {
      center: true,
      padding: "2rem",
      screens: {
        "2xl": "1400px",
      },
    },
    extend: {
      fontFamily: {
        sans: ["var(--font-sans)", ...fontFamily.sans],
      },
      colors: {
        border: "hsl(var(--border))",
        input: "hsl(var(--input))",
        ring: "hsl(var(--ring))",
        background: "hsl(var(--background))",
        foreground: "hsl(var(--foreground))",
        primary: {
          DEFAULT: "hsl(var(--primary))",
          foreground: "hsl(var(--primary-foreground))",
        },
        secondary: {
          DEFAULT: "hsl(var(--secondary))",
          foreground: "hsl(var(--secondary-foreground))",
        },
        destructive: {
          DEFAULT: "hsl(var(--destructive))",
          foreground: "hsl(var(--destructive-foreground))",
        },
        muted: {
          DEFAULT: "hsl(var(--muted))",
          foreground: "hsl(var(--muted-foreground))",
        },
        accent: {
          DEFAULT: "hsl(var(--accent))",
          foreground: "hsl(var(--accent-foreground))",
        },
        popover: {
          DEFAULT: "hsl(var(--popover))",
          foreground: "hsl(var(--popover-foreground))",
        },
        card: {
          DEFAULT: "hsl(var(--card))",
          foreground: "hsl(var(--card-foreground))",
        },
      },
      borderRadius: {
        lg: "var(--radius)",
        md: "calc(var(--radius) - 2px)",
        sm: "calc(var(--radius) - 4px)",
      },
      keyframes: {
        "accordion-down": {
          from: { height: "0" },
          to: { height: "var(--radix-accordion-content-height)" },
        },
        "accordion-up": {
          from: { height: "var(--radix-accordion-content-height)" },
          to: { height: "0" },
        },
      },
      animation: {
        "accordion-down": "accordion-down 0.2s ease-out",
        "accordion-up": "accordion-up 0.2s ease-out",
      },
    },
  },
  plugins: [require("tailwindcss-animate")],
} satisfies Config

export default config
```

</CodeWindow>

The easiest way to test that everything is OK is to remove the content of the main component `app/page.tsx` and add a Shadcn/ui button.

First run the following command in the terminal:

<CodeWindow>
```bash
    pnpm dlx shadcn-ui@latest add button
```
</CodeWindow>

Puedes observar en `components/ui` que se ha creado un archivo `button.tsx` con el componente deseado.

Elimina el contenido de `app/page.tsx` conservando la etiqueta main e instancia un botón.

Debera quedarte algo asi:

<CodeWindow title="app/page.tsx">
```TSX
import {Button} from "@/components/ui/button";

export default function Home() {
  return (
    <main className="flex min-h-screen flex-col items-center justify-between p-24">
      <Button variant="default">Click me</Button>
    </main>
  );
}

```

</CodeWindow>

And in your browser you should see something like this:

![Shadcn/ui button](/images/blog/nextjs-supabase/shadcn-ui-button.jpg)

We are going to create an app with a registration / login page and a layout for the authenticated user. We will see in detail later what we are talking about.

Let's define the initial structure of the project

Inside app we will create the following directories and `page.tsx` files

- app
    - auth
        - page.tsx
    - user
        - page.tsx

Let's start shaping our login form.

First we need to install some Shadcn/ui components, execute the following commands


<CodeWindow>
```bash
    pnpm dlx shadcn-ui@latest add card
    pnpm dlx shadcn-ui@latest add label
    pnpm dlx shadcn-ui@latest add input
    pnpm dlx shadcn-ui@latest add separator
```
</CodeWindow>

Then define the app/auth/page.tsx component in the following way:

<CodeWindow title="app/auth/page.tsx">
```TSX
import Link from "next/link";
import {Card, CardContent, CardDescription, CardHeader, CardTitle} from "@/components/ui/card";
import {Label} from "@/components/ui/label";
import {Input} from "@/components/ui/input";
import {Button} from "@/components/ui/button";
import {Separator} from "@/components/ui/separator";
import {Github} from "lucide-react";

const AuthPage = () => {
    return (
        <main className={'flex items-center h-screen'}>
            <Card className="mx-auto max-w-sm">
                <CardHeader>
                    <CardTitle className="text-2xl">Login</CardTitle>
                    <CardDescription>Use a OAuth provider or insert your credentials</CardDescription>
                </CardHeader>
                <CardContent>
                    <div className="grid gap-4">
                        <Button variant="outline" className="w-full">
                            <Github/>
                        </Button>
                        <Button variant="outline" className="w-full">
                            Login with Google
                        </Button>

                        <Separator/>

                        <div className="grid gap-2">
                            <Label htmlFor="email">Email</Label>
                            <Input id="email" type="email" placeholder="m@example.com" required/>
                        </div>
                        <div className="grid gap-2">
                            <div className="flex items-center">
                                <Label htmlFor="password">Password</Label>
                                <Link href="#" className="ml-auto inline-block text-sm underline" prefetch={false}>
                                    Forgot your password?
                                </Link>
                            </div>
                            <Input id="password" type="password" required/>
                        </div>
                        <Button type="submit" className="w-full">
                            Login
                        </Button>
                    </div>
                    <div className="mt-4 text-center te xt-sm">
                        If you don&apos;t have an account, it will be created automatically.
                    </div>
                </CardContent>
            </Card>
        </main>
    )
}

export default AuthPage;
``` 

</CodeWindow>

In the browser, on https://localhost:3000/auth you should see something like this:

![Login form](/images/blog/nextjs-supabase/shadcn-ui-login.jpg)

## Supabase

We need to create a Supabase project to serve as a backend for our app.

Visit [database.new](https://database.new), if you don't already have one, create an account, and follow the instructions to create a new project.

![Supabase project](/images/blog/nextjs-supabase/supabase-new-project.jpg)

While the project is setting up, you will see the following screen:

![Supabase project setting up](/images/blog/nextjs-supabase/supabase-setting-up.jpg)

Once the project is created, you must to go to Authentication -> Providers <br/>
For our app we will GitHub and Google as OAuth providers

## Google

Let's start by creating a Google Cloud project to link to Supabase. This will help us to accept registrations from users using Google as an OAuth provider.

[Create a project](https://console.cloud.google.com/projectcreate)

Name the project whatever you like.

It usually takes a few seconds to create the instance.

Then in [Credentials Consent](https://console.cloud.google.com/apis/credentials/consent), making sure you are in the new project (you can see the selected project in the Input Select in the upper left corner, next to the Google Cloud logo), you should select `External`.

![Google Cloud Consent](/images/blog/nextjs-supabase/google-oauth-consent.jpg)

Then click on `CREATE`.

Specify a name for the App and select your email as support email and Developer contact information at the bottom of the page.

In Authorized domains click on `ADD DOMAIN` and enter the Supabase project URL.

You can find it in Project Settings → API and it has the format `<PROJECT_ID>.supabase.co`.

> You should not indicate the protocol (https://)

![Google Cloud Consent](/images/blog/nextjs-supabase/supabase-ready.jpg)

Then click on `SAVE AND CONTINUE`.

Click on `ADD OR REMOVE SCOPES` and select the first three

- …/auth/userinfo.email
- …/auth/userinfo.profile


![Google Cloud Consent](/images/blog/nextjs-supabase/google-scopes.jpg)

Then click on `SAVE AND CONTINUE`.

Go to https://console.cloud.google.com/apis/credentials

Click on `CREATE CREDENTIALS` and choose `OAuth client ID.`.

Under Application Type select `Web Application`.

Specify a client name (only identifies the OAuth client will not be shown to the user).

In `Authorized JavaScripts origins` you must indicate the URL of your application. Start by registering your [localhost](http://localhost).

In Authorized Redirect URIs you will register the Callback URL of supabase `<PROJECT_ID>.supabase.co/auth/v1/callback`.

![Google OAuth Client Created](/images/blog/nextjs-supabase/google-oauth-client-created.png)

You must copy the Client ID and Client secret and enter them in the Google section of Supabase.

![Google Supabase Completed](/images/blog/nextjs-supabase/google-supabase-completed.png )

Click on `Save`.

Google is ready to go! We go to GitHub and at the end we implement the behavior of both options in the app.

## GitHub

From the GitHub section in Supabase, copy the Callback URL ( it is the same one we use for Google ).


![GitHub New App](/images/blog/nextjs-supabase/gh-supabase.png)
> Leave this tab open, we'll be right back.



Let's create the GitHub app, just like we did with Google.

Go to https://github.com/settings/applications/new

![GitHub New App](/images/blog/nextjs-supabase/gh-new-app.png)

Specify the data of your new App and click on `Register application`.

Next you will see the general page of your app with the Client Id, and you will see a button `Generate a new client secret`, click on it.

Register the Client Id and the new secret in Supabase, just like we did with Google.

Then click on `SAVE` and you're ready to go.

![GitHub New App](/images/blog/nextjs-supabase/gh-supabase-ready.png)


## Introduce Supabase to Nextjs

It will be the beginning of a long and fruitful relationship. <br/>
Let`s begin by installing the Supabase client.

<CodeWindow>
```bash
    pnpm add @supabase/supabase-js
    pnpm add @supabase/ssr
```
</CodeWindow>

You have to create a .env file in the root of the project with the following content:

<CodeWindow title=".env">
```env
NEXT_PUBLIC_SUPABASE_URL=https://<PROJECT_ID>.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=<ANON_KEY>
```
</CodeWindow>
> Replace `<PROJECT_ID>` and `<ANON_KEY>` with the values of your Supabase project.

> Make sure to add the .env file to your .gitignore file. You don't want to expose your keys to the public.

Now we will to create the Supabase client.

Create a file `lib/supabase/client.ts` with the following content:

<CodeWindow title="lib/supabase/client.ts">
```TS
import { createBrowserClient } from '@supabase/ssr'

export function createClient() {
    return createBrowserClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
    )
}
```
</CodeWindow>

This client will help us to interact with Supabase from the client side.

Now we will create a context to share the session and the client with the rest of the app.

create a file in /context/index.tsx with the following content:

<CodeWindow title="context/index.tsx">
```TS
import {createClient} from "@/lib/supabase/client";
import {createContext, ReactNode, useContext, useEffect, useState} from "react";
import {Session, User} from "@supabase/supabase-js";

type AuthContextType = {
    user: User | null;
    session: Session | null;
    signIn: () => void;
    signOut: () => void;
}

const AuthContext = createContext<AuthContextType | undefined>(undefined);

export const AuthProvider = ({children}: { children: ReactNode }) => {
    const [session, setSession] = useState<Session | null>(null);
    const [user, setUser] = useState<User | null>(null);

    const client = createClient();

    useEffect(() => {
        const {data: authListener} = client.auth.onAuthStateChange((event, session) => {
            setSession(session);
            setUser(session?.user ?? null);
        });

        return () => {
            authListener?.unsubscribe();
        }
    }, []);

    const signIn = async () => {
        await client.auth.signIn({provider: 'github'});
    }

    const signOut = async () => {
        await client.auth.signOut();
    }

    return (
        <AuthContext.Provider value={{user, session, signIn, signOut}}>
            {children}
        </AuthContext.Provider>
    )
}

export const useAuth = () => {
    const context = useContext(AuthContext);
    if (context === undefined) {
        throw new Error('useAuth must be used within an AuthProvider');
    }
    return context;
}
```
</CodeWindow>

This context will help us to share the session and the user with the rest of the app.

Now we will create a hook to use the session and the user in the components.

Create a file in /hooks/useAuth.ts with the following content:

<CodeWindow title="hooks/useAuth.ts">
```TS
import {useAuth} from "@/context";

export const useSession = () => {
    const {session} = useAuth();
    return session;
}

export const useUser = () => {
    const {user} = useAuth();
    return user;
}
```
</CodeWindow>

This hook will help us to use the session and the user in the components.

Now we will create a component to show the user information and the sign in and sign out buttons.

Create a file in /components/UserInfo.tsx with the following content:

<CodeWindow title="components/UserInfo.tsx">
```TS

import {useUser} from "@/hooks/useAuth";

export const UserInfo = () => {
    const user = useUser();

    return (
        <div className="flex items-center">
            {user ? (
                <>
                    <img src={user.user_metadata.avatar_url} alt={user.user_metadata.full_name} className="w-8 h-8 rounded-full"/>
                    <span className="ml-2">{user.user_metadata.full_name}</span>
                </>
            ) : (
                <span>Not logged in</span>
            )}
        </div>
    )
}
```
</CodeWindow>


WORK IN PROGRESS...